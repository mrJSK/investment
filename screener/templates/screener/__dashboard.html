{% extends 'screener/base.html' %} {% load static %} {% block content %}
<div class="container-fluid" style="max-width: 1200px">
  <div class="row">
    <!-- Sidebar filters -->
    <div class="col-lg-3 mb-3">
      <div class="sidebar bg-white rounded shadow-sm p-4">
        <h6 class="mb-3">üîç Quick Filters</h6>
        <label>Market Cap</label>
        <select class="form-select mb-2" id="marketCap">
          <option value="">All</option>
          <option value="Large Cap">Large Cap</option>
          <option value="Mid Cap">Mid Cap</option>
          <option value="Small Cap">Small Cap</option>
        </select>
        <label>Sector</label>
        <select class="form-select mb-2" id="sector">
          <option value="">All</option>
          <option value="IT">IT</option>
          <option value="Finance">Finance</option>
          <option value="Energy">Energy</option>
        </select>
        <label>Volume</label>
        <input
          type="range"
          class="form-range"
          min="0"
          max="100"
          value="30"
          id="volumeSlider"
        />
      </div>
    </div>
    <div class="col-lg-9">
      <!-- Screener summary -->
      <div class="mb-2 small d-flex align-items-center flex-wrap">
        <span>
          Stock passes <b>all</b> of the below filters in
          <select
            id="segmentDropdown"
            class="segment-dropdown border-0 bg-transparent text-primary fw-bold"
            style="font-size: 1em"
          >
            <option value="Nifty 50">Nifty 50</option>
            <option value="Nifty 100">Nifty 100</option>
            <option value="Nifty 500">Nifty 500</option>
            <option value="All NSE">All NSE</option>
            <option value="Custom">Custom</option>
          </select>
          segment:
        </span>
        <button class="btn btn-link btn-sm text-decoration-none ms-2">
          üìã
        </button>
      </div>

      <!-- Filter builder area -->
      <form id="filterBuilder" autocomplete="off">
        <div id="conditions"></div>
        <div class="d-flex mb-3">
          <button
            class="btn btn-outline-primary me-2"
            type="button"
            id="addFilter"
          >
            <b>+</b> Add Filter
          </button>
        </div>
      </form>
      <!-- Action bar -->
      <div class="action-bar d-flex flex-wrap mb-3 gap-2">
        <button class="btn btn-success" type="button" id="runScan">
          <span>‚ñ∂Ô∏è</span> Run Scan
        </button>
        <button class="btn btn-outline-success" type="button">
          <span>üíæ</span> Save Scan
        </button>
        <button class="btn btn-info text-white" type="button">
          <span>üìã</span> Copy Scan
        </button>
        <button class="btn btn-danger" type="button">
          <span>‚ù§Ô∏è</span> Love Scan
        </button>
        <button class="btn btn-warning" type="button">
          <span>üîî</span> Create Alert
        </button>
        <button class="btn btn-dark" type="button">
          <span>üñ•Ô∏è</span> Monitor on dashboard
        </button>
        <button
          class="btn btn-primary"
          style="background: #e100ff; border: none"
          type="button"
        >
          <span>üîÑ</span> Backtest Results
        </button>
      </div>

      <!-- Results Table -->
      <div class="card shadow-sm mb-5">
        <div
          class="card-header bg-primary text-white d-flex align-items-center justify-content-between"
        >
          <span>Screener Results</span>
          <button class="btn btn-light btn-sm" id="exportCSV">
            Export CSV
          </button>
        </div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0" id="resultsTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Symbol</th>
                <th>Last Price</th>
                <th>Change %</th>
                <th>Volume</th>
                <th>Matched</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="resultsBody">
              <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                  No results yet.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Indicator Picker Modal -->
<div
  class="modal fade"
  id="indicatorModal"
  tabindex="-1"
  aria-labelledby="indicatorModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="indicatorModalLabel">
          Select Indicator or Function
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <input
          type="text"
          id="indicatorSearch"
          class="form-control mb-3"
          placeholder="Search indicator, e.g. RSI, Close, SMA..."
        />
        <ul
          class="list-group"
          id="indicatorList"
          style="max-height: 320px; overflow: auto"
        ></ul>
      </div>
    </div>
  </div>
</div>

<style>
  .filter-card {
    border-radius: 14px;
    box-shadow: 0 2px 10px #ececec;
    background: #fff;
  }
  .badge-buy {
    background: #3adb76 !important;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ==== DYNAMIC FILTER BUILDER ====
  let allIndicators = [];
  // Fetch indicators on page load
  fetch("/screener/api/indicators/")
    .then((resp) => resp.json())
    .then((data) => {
      allIndicators = [
        { value: "open", label: "Open" },
        { value: "high", label: "High" },
        { value: "low", label: "Low" },
        { value: "close", label: "Close" },
        { value: "volume", label: "Volume" },
        ...data.indicators,
      ];
      renderIndicators(""); // Initial render in the picker modal
    });

  // Indicator picker modal code:
  function renderIndicators(filter = "") {
    const list = document.getElementById("indicatorList");
    list.innerHTML = "";

    // Add a value entry option (for right side)
    if (activeInput && activeInput.classList.contains("right-indicator")) {
      const valueLi = document.createElement("li");
      valueLi.className = "list-group-item list-group-item-action";
      valueLi.style.cursor = "pointer";
      valueLi.textContent = "Enter Value‚Ä¶";
      valueLi.onclick = () => selectValueEntry();
      list.appendChild(valueLi);
    }

    allIndicators
      .filter((i) => i.label.toLowerCase().includes(filter.toLowerCase()))
      .forEach((indicator) => {
        const li = document.createElement("li");
        li.className = "list-group-item list-group-item-action";
        li.style.cursor = "pointer";
        li.textContent = indicator.label;
        li.onclick = () => selectIndicator(indicator.value);
        list.appendChild(li);
      });
  }

  // Add a modal for indicator parameters
  function showIndicatorParamsModal(indicatorValue, onSubmit) {
    fetch(`/screener/api/indicator_params/?fn=${indicatorValue}`)
      .then((resp) => resp.json())
      .then((data) => {
        let formHtml = "";
        if (data.params && data.params.length) {
          data.params.forEach((param) => {
            if (param.type === "series") {
              formHtml += `<label>${param.name}</label>
                <select class="form-select mb-2" name="${param.name}">
                  <option value="close">Close</option>
                  <option value="open">Open</option>
                  <option value="high">High</option>
                  <option value="low">Low</option>
                  <option value="volume">Volume</option>
                </select>`;
            } else {
              formHtml += `<label>${param.name}</label>
                <input class="form-control mb-2" name="${
                  param.name
                }" type="number" value="${
                param.default !== null ? param.default : ""
              }" />`;
            }
          });
        }
        const paramModal = document.createElement("div");
        paramModal.className = "modal fade";
        paramModal.id = "indicatorParamsModal";
        paramModal.tabIndex = -1;
        paramModal.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Indicator Parameters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <form id="paramForm">
                <div class="modal-body">
                  ${formHtml}
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">OK</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.appendChild(paramModal);
        const bsModal = new bootstrap.Modal(paramModal);
        bsModal.show();

        paramModal.querySelector("#paramForm").onsubmit = function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          const paramStr = Array.from(formData.entries())
            .map(([k, v]) => v)
            .join(", ");
          onSubmit(`${indicatorValue}(${paramStr})`);
          bsModal.hide();
          setTimeout(() => paramModal.remove(), 500);
        };
        paramModal.querySelector(".btn-close").onclick = function () {
          bsModal.hide();
          setTimeout(() => paramModal.remove(), 500);
        };
      });
  }

  // ==== Filter row template with identifiable classes ====
  function newConditionRow(idx = 0) {
    return `
  <div class="filter-card px-3 py-2 mb-2 d-flex align-items-center flex-wrap rounded shadow-sm bg-white gap-2 condition-row">
    <span class="filter-index badge bg-light text-secondary" style="font-size:1em;">[${idx}]</span>
    <input type="text" class="form-control indicator-select left-indicator" style="width:130px;cursor:pointer" placeholder="Indicator" readonly>
    <select class="form-select mx-2" style="width:80px">
      <option value=">">&gt;</option>
      <option value="<">&lt;</option>
      <option value=">=">&ge;</option>
      <option value="<=">&le;</option>
      <option value="==">=</option>
    </select>
    <input type="text" class="form-control indicator-select right-indicator" style="width:130px;cursor:pointer" placeholder="Indicator/Value" readonly>
    <input type="text" class="form-control ms-1" style="width:90px" placeholder="Constant">
    <select class="form-select mx-2" style="width:80px">
      <option value="AND">AND</option>
      <option value="OR">OR</option>
    </select>
    <button class="icon-btn remove-condition" type="button" title="Remove"><span>‚ùå</span></button>
    <button class="icon-btn" type="button" title="Copy"><span>üìã</span></button>
    <button class="icon-btn" type="button" title="Explain"><span>‚ùì</span></button>
  </div>
  `;
  }

  let filterCount = 0;
  function refreshIndices() {
    document.querySelectorAll("#conditions .filter-card").forEach((row, i) => {
      row.querySelector(".filter-index").textContent = `[${i}]`;
    });
  }
  function addConditionRow() {
    let container = document.getElementById("conditions");
    container.insertAdjacentHTML("beforeend", newConditionRow(filterCount));
    filterCount++;
    refreshIndices();
    bindFilterEvents();
  }
  function bindFilterEvents() {
    document.querySelectorAll(".remove-condition").forEach((btn) => {
      btn.onclick = function () {
        this.closest(".condition-row").remove();
        refreshIndices();
        filterCount = document.querySelectorAll(
          "#conditions .filter-card"
        ).length;
      };
    });
    document.querySelectorAll(".indicator-select").forEach((el) => {
      el.onclick = function () {
        activeInput = this;
        // Is it left or right?
        renderIndicators("");
        let modal = new bootstrap.Modal(
          document.getElementById("indicatorModal")
        );
        modal.show();
      };
    });
  }
  document.getElementById("addFilter").onclick = addConditionRow;
  addConditionRow(); // One filter row on load

  // ==== INDICATOR PICKER MODAL ====
  let activeInput = null;
  document
    .getElementById("indicatorSearch")
    .addEventListener("input", function () {
      renderIndicators(this.value);
    });

  function selectIndicator(indicatorValue) {
    // Find the label for display
    const indicatorObj = allIndicators.find((i) => i.value === indicatorValue);
    // If indicator needs params, show param dialog
    fetch(`/screener/api/indicator_params/?fn=${indicatorValue}`)
      .then((resp) => resp.json())
      .then((data) => {
        if (data.params && data.params.length) {
          showIndicatorParamsModal(indicatorValue, (label) => {
            if (activeInput) activeInput.value = label;
          });
        } else {
          if (activeInput)
            activeInput.value = indicatorObj
              ? indicatorObj.label
              : indicatorValue;
        }
        let modal = bootstrap.Modal.getInstance(
          document.getElementById("indicatorModal")
        );
        modal.hide();
      });
  }

  function selectValueEntry() {
    if (activeInput) {
      // Turn this input into a number input temporarily
      const val = prompt("Enter value (e.g. 60):");
      activeInput.value = val || "";
    }
    let modal = bootstrap.Modal.getInstance(
      document.getElementById("indicatorModal")
    );
    modal.hide();
  }

  renderIndicators(""); // Initial render

  // ==== AJAX RUN SCAN (unchanged) ====
  document.getElementById("runScan").onclick = function (e) {
    e.preventDefault();
    let rows = document.querySelectorAll("#conditions .filter-card");
    let filters = [];
    rows.forEach((row) => {
      let children = row.querySelectorAll("input,select");
      filters.push({
        left: children[0].value,
        op: children[1].value,
        right: children[2].value,
        constant: children[3].value,
        logic: children[4].value,
      });
    });
    let payload = {
      filters: filters,
      market_cap: document.getElementById("marketCap").value,
      sector: document.getElementById("sector").value,
      volume: document.getElementById("volumeSlider").value,
      segment: document.getElementById("segmentDropdown").value,
    };
    fetch("{% url 'ajax_scan' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify(payload),
    })
      .then((resp) => resp.json())
      .then((data) => {
        let tbody = document.getElementById("resultsBody");
        tbody.innerHTML = "";
        if (data.results && data.results.length) {
          data.results.forEach((row, idx) => {
            tbody.innerHTML += `<tr>
          <td>${idx + 1}</td>
          <td>${row.symbol}</td>
          <td>${row.price}</td>
          <td>${row.change}</td>
          <td>${row.volume}</td>
          <td>${row.matched}</td>
          <td>${
            row.signal
              ? `<span class="badge bg-success">${row.signal}</span>`
              : ""
          }</td>
        </tr>`;
          });
        } else {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center py-4 text-muted">No results.</td></tr>';
        }
      });
  };
</script>
{% endblock %}
