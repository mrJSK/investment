{% extends 'screener/base.html' %} {% load static %} {% block content %}
<div class="container-fluid" style="max-width: 1200px">
  <div class="row">
    <!-- Sidebar (optional, for consistency) -->
    <div class="col-lg-3 mb-3">
      <div class="sidebar bg-white rounded shadow-sm p-4">
        <h6 class="mb-3">üìù Scan Details</h6>
        <form id="scanMetaForm">
          <div class="mb-2">
            {{ form.name.label_tag }} {{ form.name|add_class:"form-control" }}
          </div>
          <div class="mb-2">
            {{ form.timeframe.label_tag }} {{
            form.timeframe|add_class:"form-select" }}
          </div>
          <div class="mb-2">
            {{ form.segment.label_tag }} {{ form.segment|add_class:"form-select"
            }}
          </div>
        </form>
      </div>
    </div>

    <!-- Main Screener Form -->
    <div class="col-lg-9">
      <h3 class="mb-3">{% if scan %}Edit Scan{% else %}New Scan{% endif %}</h3>
      <form method="post" id="screenerForm" autocomplete="off">
        {% csrf_token %}
        <div id="conditions">
          {{ formset.management_form }} {% for form in formset %}
          <div
            class="filter-card px-3 py-2 mb-2 d-flex align-items-center flex-wrap rounded shadow-sm bg-white gap-2 condition-row"
          >
            <span
              class="filter-index badge bg-light text-secondary"
              style="font-size: 1em"
              >[{{ forloop.counter0 }}]</span
            >
            <!-- Left Indicator -->
            <input
              type="text"
              class="form-control indicator-select"
              style="width: 130px; cursor: pointer"
              name="{{ form.left_indicator.name }}"
              value="{{ form.left_indicator.value|default_if_none:'' }}"
              placeholder="Indicator"
              readonly
            />
            {{ form.operator|add_class:'form-select mx-2' }}
            <!-- Right Indicator / Constant -->
            <input
              type="text"
              class="form-control indicator-select"
              style="width: 130px; cursor: pointer"
              name="{{ form.right_indicator.name }}"
              value="{{ form.right_indicator.value|default_if_none:'' }}"
              placeholder="Indicator (or leave blank)"
            />
            {{ form.constant|add_class:'form-control ms-1' }} {{
            form.logic|add_class:'form-select mx-2' }}
            <!-- Remove -->
            {% if not forloop.first %}
            <button
              class="icon-btn remove-condition"
              type="button"
              title="Remove"
            >
              <span>‚ùå</span>
            </button>
            {% endif %}
            <button class="icon-btn" type="button" title="Copy">
              <span>üìã</span>
            </button>
            <button class="icon-btn" type="button" title="Explain">
              <span>‚ùì</span>
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="d-flex mb-3">
          <button
            class="btn btn-outline-primary me-2"
            type="button"
            id="addFilter"
          >
            <b>+</b> Add Condition
          </button>
        </div>
        <button type="submit" class="btn btn-primary px-4">üíæ Save Scan</button>
      </form>
    </div>
  </div>
</div>

<!-- Indicator Picker Modal (same as dashboard) -->
<div
  class="modal fade"
  id="indicatorModal"
  tabindex="-1"
  aria-labelledby="indicatorModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="indicatorModalLabel">
          Select Indicator or Function
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <input
          type="text"
          id="indicatorSearch"
          class="form-control mb-3"
          placeholder="Search indicator, e.g. RSI, Close, SMA..."
        />
        <ul
          class="list-group"
          id="indicatorList"
          style="max-height: 320px; overflow: auto"
        ></ul>
      </div>
    </div>
  </div>
</div>

<style>
  .filter-card {
    border-radius: 14px;
    box-shadow: 0 2px 10px #ececec;
    background: #fff;
  }
  .badge-buy {
    background: #3adb76 !important;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // INDICATOR PICKER LOGIC
  const allIndicators = [
    "Open",
    "High",
    "Low",
    "Close",
    "Volume",
    "SMA",
    "EMA",
    "VWAP",
    "RSI",
    "MACD",
    "ATR",
    "ADX",
    "EFI",
    "Supertrend",
    "Bollinger Bands",
    "Donchian Channel",
    "Stochastic",
    "ROC",
    "CCI",
    "MFI",
    "OBV",
    "Williams %R",
    "Hull MA",
    "Min(20, Close)",
    "Max(20, Close)",
    "SMA(volume, 20)",
    "SMA(close, 9)",
    "EMA(close, 21)",
  ];
  function renderIndicators(filter = "") {
    const list = document.getElementById("indicatorList");
    list.innerHTML = "";
    allIndicators
      .filter((i) => i.toLowerCase().includes(filter.toLowerCase()))
      .forEach((indicator) => {
        const li = document.createElement("li");
        li.className = "list-group-item list-group-item-action";
        li.style.cursor = "pointer";
        li.textContent = indicator;
        li.onclick = () => selectIndicator(indicator);
        list.appendChild(li);
      });
  }
  let activeInput = null;
  document.querySelectorAll(".indicator-select").forEach((el) => {
    el.onclick = function () {
      activeInput = this;
      renderIndicators("");
      let modal = new bootstrap.Modal(
        document.getElementById("indicatorModal")
      );
      modal.show();
    };
  });
  document
    .getElementById("indicatorSearch")
    .addEventListener("input", function () {
      renderIndicators(this.value);
    });
  function selectIndicator(indicator) {
    if (activeInput) activeInput.value = indicator;
    let modal = bootstrap.Modal.getInstance(
      document.getElementById("indicatorModal")
    );
    modal.hide();
  }
  renderIndicators(""); // Initial render

  // ADD/REMOVE DYNAMIC CONDITION ROWS FOR DJANGO FORMSET
  function updateFormIndices() {
    let forms = document.querySelectorAll("#conditions .condition-row");
    let total = forms.length;
    document.getElementById("id_form-TOTAL_FORMS").value = total;
    forms.forEach(function (row, idx) {
      row.querySelectorAll("input, select").forEach(function (input) {
        input.name = input.name.replace(/form-(\d+)-/, `form-${idx}-`);
        input.id = input.id.replace(/form-(\d+)-/, `form-${idx}-`);
      });
      row.querySelector(".filter-index").textContent = `[${idx}]`;
    });
  }
  document.getElementById("addFilter").addEventListener("click", function (e) {
    e.preventDefault();
    let last = document.querySelector("#conditions .condition-row:last-child");
    let clone = last.cloneNode(true);
    // Reset values
    clone.querySelectorAll("input").forEach((inp) => (inp.value = ""));
    clone.querySelectorAll("select").forEach((sel) => (sel.selectedIndex = 0));
    // Remove errors (if any)
    clone.querySelector(".remove-condition").onclick = function () {
      this.closest(".condition-row").remove();
      updateFormIndices();
    };
    document.getElementById("conditions").appendChild(clone);
    updateFormIndices();
    // Re-apply indicator picker
    clone.querySelectorAll(".indicator-select").forEach((el) => {
      el.onclick = function () {
        activeInput = this;
        renderIndicators("");
        let modal = new bootstrap.Modal(
          document.getElementById("indicatorModal")
        );
        modal.show();
      };
    });
  });
  // Initial remove button logic
  document.querySelectorAll(".remove-condition").forEach((btn) => {
    btn.onclick = function () {
      this.closest(".condition-row").remove();
      updateFormIndices();
    };
  });
</script>
{% endblock %}
